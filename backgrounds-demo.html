<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chortle Backgrounds Demo - AI Segmentation Test</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .demo-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #00BBF9;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #00BBF9;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }
        
        .test-btn {
            background: #00BBF9;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 1em;
        }
        
        .test-btn:hover {
            background: #0099CC;
        }
        
        .test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        
        .debug-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .video-container {
            text-align: center;
            margin: 20px 0;
        }
        
        #demo-video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            background: #000;
        }
        
        #demo-canvas {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            border: 2px solid #00BBF9;
            display: none;
        }
        
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #00BBF9;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <h1>üé¨ Chortle AI Backgrounds Demo</h1>
        
        <div class="status-section">
            <h3>System Status</h3>
            <div id="system-status">
                <p>üîÑ Checking system capabilities...</p>
            </div>
        </div>
        
        <div class="test-section">
            <h3>Phase 1: AI Segmentation Test</h3>
            <p>Test MediaPipe Selfie Segmentation performance and quality</p>
            
            <button class="test-btn" onclick="startCamera()" id="start-camera-btn">üìπ Start Camera</button>
            <button class="test-btn" onclick="loadSegmentation()" id="load-ai-btn" disabled>ü§ñ Load AI Model</button>
            <button class="test-btn" onclick="startSegmentation()" id="start-seg-btn" disabled>üéØ Start Segmentation</button>
            <button class="test-btn" onclick="loadBackground()" id="load-bg-btn" disabled>üåÖ Load Test Background</button>
            <button class="test-btn" onclick="startCompositing()" id="start-comp-btn" disabled>üé® Start Compositing</button>
        </div>
        
        <div class="video-container">
            <video id="demo-video" autoplay muted playsinline></video>
            <canvas id="demo-canvas"></canvas>
        </div>
        
        <div class="test-section">
            <h3>Performance Metrics</h3>
            <div class="performance-metrics">
                <div class="metric-card">
                    <div class="metric-value" id="fps-counter">0</div>
                    <div>FPS</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="memory-usage">0</div>
                    <div>Memory (MB)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="load-time">0</div>
                    <div>Load Time (s)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="success-rate">0</div>
                    <div>Success Rate (%)</div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>Debug Output</h3>
            <div id="debug-output" class="debug-output"></div>
        </div>
        
        <div class="test-section">
            <h3>Instructions</h3>
            <ol>
                <li><strong>Start Camera:</strong> Enable camera access</li>
                <li><strong>Load AI Model:</strong> Download MediaPipe Selfie Segmentation</li>
                <li><strong>Start Segmentation:</strong> Begin real-time person detection</li>
                <li><strong>Load Background:</strong> Load a test background image</li>
                <li><strong>Start Compositing:</strong> Combine person + background</li>
            </ol>
            
            <h4>Success Criteria:</h4>
            <ul>
                <li>FPS > 15 on mobile devices</li>
                <li>AI model loads in < 8 seconds</li>
                <li>Segmentation quality acceptable</li>
                <li>No memory leaks during extended use</li>
            </ul>
        </div>
    </div>

    <script>
        // Demo state
        let demoState = {
            camera: null,
            segmentation: null,
            canvas: null,
            ctx: null,
            backgroundImage: null,
            isSegmenting: false,
            performanceStart: 0,
            frameCount: 0,
            fpsInterval: null
        };
        
        let debugLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLog.push(logEntry);
            
            const output = document.getElementById('debug-output');
            output.innerHTML = debugLog.slice(-20).join('\n');
            output.scrollTop = output.scrollHeight;
            
            console.log(message);
        }
        
        function updateSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            let status = '';
            
            // Check browser capabilities
            const hasCamera = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            const hasWebGL = !!window.WebGLRenderingContext;
            const hasCanvas = !!document.createElement('canvas').getContext;
            
            status += `<p class="${hasCamera ? 'success' : 'error'}">${hasCamera ? '‚úÖ' : '‚ùå'} Camera Access</p>`;
            status += `<p class="${hasWebGL ? 'success' : 'error'}">${hasWebGL ? '‚úÖ' : '‚ùå'} WebGL Support</p>`;
            status += `<p class="${hasCanvas ? 'success' : 'error'}">${hasCanvas ? '‚úÖ' : '‚ùå'} Canvas Support</p>`;
            
            // Check if on mobile
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            status += `<p class="warning">üì± Device: ${isMobile ? 'Mobile' : 'Desktop'}</p>`;
            
            statusDiv.innerHTML = status;
            
            // Enable next step if camera is available
            if (hasCamera) {
                document.getElementById('start-camera-btn').disabled = false;
            }
        }
        
        async function startCamera() {
            log('üé• Starting camera...');
            demoState.performanceStart = performance.now();
            
            try {
                const constraints = {
                    video: {
                        facingMode: 'user',
                        width: { ideal: 1080 },
                        height: { ideal: 1920 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('demo-video');
                video.srcObject = stream;
                
                demoState.camera = stream;
                
                video.onloadedmetadata = () => {
                    log(`‚úÖ Camera started: ${video.videoWidth}x${video.videoHeight}`);
                    document.getElementById('load-ai-btn').disabled = false;
                    
                    // Setup canvas
                    const canvas = document.getElementById('demo-canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    demoState.canvas = canvas;
                    demoState.ctx = canvas.getContext('2d');
                };
                
            } catch (error) {
                log(`‚ùå Camera error: ${error.message}`, 'error');
            }
        }
        
        async function loadSegmentation() {
            log('ü§ñ Loading MediaPipe Selfie Segmentation...');
            const loadStart = performance.now();
            
            try {
                // This would load the actual MediaPipe library
                // For now, simulate loading time
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const loadTime = ((performance.now() - loadStart) / 1000).toFixed(1);
                document.getElementById('load-time').textContent = loadTime;
                
                log(`‚úÖ AI model loaded in ${loadTime}s`);
                document.getElementById('start-seg-btn').disabled = false;
                
                // Simulate segmentation object
                demoState.segmentation = { ready: true };
                
            } catch (error) {
                log(`‚ùå AI loading error: ${error.message}`, 'error');
            }
        }
        
        function startSegmentation() {
            log('üéØ Starting real-time segmentation...');
            demoState.isSegmenting = true;
            document.getElementById('load-bg-btn').disabled = false;
            
            // Start FPS counter
            startFPSCounter();
            
            // Simulate segmentation loop
            simulateSegmentation();
        }
        
        function loadBackground() {
            log('üåÖ Loading test background...');
            
            // Create a simple test background
            const canvas = document.createElement('canvas');
            canvas.width = 1080;
            canvas.height = 1920;
            const ctx = canvas.getContext('2d');
            
            // Create gradient background
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#FF6B6B');
            gradient.addColorStop(1, '#4ECDC4');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Add some text
            ctx.fillStyle = 'white';
            ctx.font = 'bold 60px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('TEST BACKGROUND', canvas.width/2, canvas.height/2);
            
            demoState.backgroundImage = canvas;
            
            log('‚úÖ Test background loaded');
            document.getElementById('start-comp-btn').disabled = false;
        }
        
        function startCompositing() {
            log('üé® Starting background compositing...');
            
            const canvas = document.getElementById('demo-canvas');
            canvas.style.display = 'block';
            
            // Start compositing loop
            compositingLoop();
        }
        
        function compositingLoop() {
            if (!demoState.isSegmenting) return;
            
            const video = document.getElementById('demo-video');
            const canvas = demoState.canvas;
            const ctx = demoState.ctx;
            
            if (video.videoWidth > 0) {
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Draw background
                if (demoState.backgroundImage) {
                    ctx.drawImage(demoState.backgroundImage, 0, 0, canvas.width, canvas.height);
                }
                
                // Draw person (simplified - would normally be segmented)
                ctx.globalAlpha = 0.8;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                ctx.globalAlpha = 1.0;
                
                // Update frame count for FPS
                demoState.frameCount++;
            }
            
            requestAnimationFrame(compositingLoop);
        }
        
        function simulateSegmentation() {
            // Simulate segmentation performance metrics
            let successCount = 0;
            let totalAttempts = 0;
            
            const segmentationLoop = () => {
                if (!demoState.isSegmenting) return;
                
                totalAttempts++;
                
                // Simulate 85% success rate
                if (Math.random() > 0.15) {
                    successCount++;
                }
                
                const successRate = ((successCount / totalAttempts) * 100).toFixed(0);
                document.getElementById('success-rate').textContent = successRate;
                
                setTimeout(segmentationLoop, 100); // 10fps simulation
            };
            
            segmentationLoop();
        }
        
        function startFPSCounter() {
            demoState.frameCount = 0;
            const startTime = performance.now();
            
            demoState.fpsInterval = setInterval(() => {
                const elapsed = (performance.now() - startTime) / 1000;
                const fps = Math.round(demoState.frameCount / elapsed);
                
                document.getElementById('fps-counter').textContent = fps;
                
                // Update memory usage (simulated)
                const memoryMB = (performance.memory ? 
                    Math.round(performance.memory.usedJSHeapSize / 1024 / 1024) : 
                    Math.round(Math.random() * 50 + 20));
                document.getElementById('memory-usage').textContent = memoryMB;
                
            }, 1000);
        }
        
        // Initialize demo when page loads
        window.addEventListener('load', () => {
            log('üé¨ Backgrounds Demo Loaded');
            updateSystemStatus();
        });
    </script>
</body>
</html>
